<!DOCTYPE html>
<title>Powerpage Web Crawler</title>
<style>
body, input, button { font-family:calibri, arial }
#left  { float:left; width:60%; height:calc(100vh - 100px); border:1px solid grey; overflow:auto; padding:6px }
#right { float:right; width:38%; height:calc(100vh - 100px); border:1px solid grey; overflow:auto; padding:6px }
li:hover { background:lightgreen; }
</style>
<body style="font-family:calibri">
<div id=header style="padding:8px">
  <table>
    <tr>
      <td><b>base link</b> 
      <td><input id=baseurl name=baseurl size=48 value='https://ckhung.wordpress.com/' /> 
      <td><b>for index like  
      <td><input id=idxpage name=idxpage size=48 value='/category/' />
      <td><input id=silent name=silent type=checkbox checked>Silent</input> 
      <td><button onclick="crawlStart(1)">Crawl Once</button>
      <td><button onclick="loadSites()">Load Sites</button>
      <td><button onclick="saveToHtml()" disabled>Save All to html</button>  
    </tr>
    <tr>
      <td><b>find page like</b>  
      <td><input id=pattern name=pattern size=48 value='/20[0-2][0-9]/[01][0-9]/[0-3][0-9]/' />
      <td><b>select content  
      <td><input id=capture name=capture size=48 value='.post-header, .post-content > :not(.sharedaddy):not(script)' />
      <td><button id=btnStop onclick="maxLevel=0" disabled>Stop</button>
      <td><button id=btnCrawlAll onclick="crawlStart()">Crawl All</button>
      <td><button onclick="saveToDb()" disabled>Save2DB</button> 
      <td><button onclick="batchToPdf()">Generate Batch (All2Pdf)</button>  
    </tr>
  </table>
</div>  
<div id=left>
<p>Recommended input the base url, and click [Crawl Once] to check url pattern</p>
<p>please use <b>RegExp</b> to filter the proper index link and page link, and input the css select string for "select content"</p>
</div>
<div id=right></div>
</body>

<script>
var baseUrl, pattern, idxpage, capture, count=0, maxLevel=1
var listPage, listTodo, result, silent, sites, textbuffer

// start/stop crawl index
function crawlStart(level) {
  document.getElementById('btnStop').disabled = false
  baseUrl = document.getElementById('baseurl').value  
  pattern = document.getElementById('pattern').value
  idxpage = document.getElementById('idxpage').value 
  listTodo = [ baseUrl ]
  listPage = []
  result = []
  count = -1
  maxLevel = (level||999) 
  crawlNext()
}

// crawl next
function crawlNext() {
  count++
  console.log('now='+count+', max='+maxLevel+', url='+listTodo[count])
  if ( count<maxLevel && count < listTodo.length ) {  
     silent = ( document.getElementById('silent').checked? ',silent=yes' : '' )           
     pb.callback('captureIndex').popup( 'mode=crawl'+silent+',key=a,url=' + listTodo[count] )
  } else {
    document.getElementById('btnStop').disabled = true
  } 
}       

// process result from crawling index page
function captureIndex ( result, type, url ) {
  var i, link, html='', msg=''
  var rs = JSON.parse( result||'{}' )
  document.getElementById('right').innerHTML = result
  
  for (i=0; i<rs.links.length; i++) {
    link = rs.links[i].url.split('#')[0]
    if ( link.search(/\.(jpg|png|pdf)$/i)>=0 ) continue;
    if (!idxpage || link.search(idxpage)>=0 ) {
      if ( listTodo.indexOf(link)<0 ) listTodo.push(link); 
    }
    if (!pattern || link.search(pattern)>=0 ) {
      if ( listPage.indexOf(link)<0 ) listPage.push(link);
    }  
  }

  for (i in listTodo) html += (i<=count? '<b style="color:green">crawled: </b>' : '[to-do]: ') + listTodo[i] + '\n<br>'
  html += '<hr/><b>Content Pages</b>(double-click to crawl content)<ul>'
  for (i=0; i<listPage.length; i++) html += '\n <li ondblclick="captureContent('+i+')">' + listPage[i]
      
  document.getElementById('left').innerHTML = html + '</ul>'
  document.getElementById('right').innerHTML = msg

  setTimeout("crawlNext()", 600 ); 
}

// capture page content 
function captureContent (n) {
  capture = document.getElementById('capture').value
  silent = ( document.getElementById('silent').checked? ';silent=yes' : '' )
  pb.callback('showContent').popup( 'delim=;mode=crawl' + silent + ';key=' + capture + ';url=' + listPage[n] )
}

// show page content
function showContent( result, type, url ) {
  var rs = JSON.parse( result||'{}' )
  document.getElementById('right').innerHTML = rs.html
}

// load sites from db
function loadSites() {
  pb.callback('showSites').db.query('select * from pp_sites order by 1,2')
}

// show sites based on db query result.
function showSites ( result, type, url ) {
  sites = JSON.parse( result||'{}' )
  for (var html='',i=0; i<sites.data.length; i++) {
    html += '<li onclick="loadSiteConfig(' + i + ')" ondblclick="crawlStart(1)">' + sites.data[i][0] 
    html += ' &nbsp;&nbsp;<small style="color:blue">' + sites.data[i][1] + '</small>'
  }  
  document.getElementById('right').innerHTML = '<b>Click to load setting of below sites</b><br><ol>' + html + '</ol>'  
}

// load site setting
function loadSiteConfig(n) {
  document.getElementById('baseurl').value = sites.data[n][1]  
  document.getElementById('idxpage').value = sites.data[n][2] 
  document.getElementById('pattern').value = sites.data[n][3] 
  document.getElementById('capture').value = sites.data[n][4]
}

// generate batch to save raw pages to pdf
function batchToPdf() {
  if (!listPage) {
    alert('Please click [crawl once] or [crawl all] to find content pages first')
  } else {  
    var i, name, batch
    var folder = baseUrl.replace(/http[s]:\/\/(.*)/i,'$1').replace(/\//g,'-').replace(/-$/,'')
    batch = '@echo off\nmkdir ' + folder
    capture = document.getElementById('capture').value
    silent = ( document.getElementById('silent').checked? ';silent=yes' : '' )
    
    for ( i=0; i<listPage.length; i++ ) {
      name = listPage[i].replace( baseUrl, '' )
      name = name.replace(/\//g,'-').replace(/-$/,'').replace(/\.(.+)$/, '' ) 
      //pb.callback('saveToPdfDone').popup( 'delim=;mode=pdf' + silent + ';key=' + capture + ';url=' + listPage[i] )
      batch += '\nwkhtmltopdf.exe  "' + listPage[i] + '"  "' + folder + '\\' + name + '.pdf" '
    }
    textbuffer = batch
    pb.callback('batchCreated').file.write( folder+'.bat', '@textbuffer' )
    document.getElementById('right').innerHTML = '<pre>' + batch + '</pre>'
  }  
}

function batchCreated() { alert('Batch file has been generated and saved!') }
</script>
